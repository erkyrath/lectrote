const dummyArgInt={serialize:()=>({}),}
class ZVMDispatch
{constructor()
{this.class_map={'fileref':{},'stream':{},'window':{},}
this.last_used_id=101}
check_autosave()
{return!this.vm.glk_blocking_call}
class_obj_from_id(clas,val)
{return this.class_map[clas][val]}
class_register(clas,obj,usedisprock)
{if(usedisprock)
{if(obj.disprock!==usedisprock)
{throw new Error('class_register: object is not already registered')}
if(this.last_used_id<=usedisprock)
{this.last_used_id=usedisprock+1}}
else
{if(obj.disprock)
{throw new Error('class_register: object is already registered')}
obj.disprock=this.last_used_id++}
this.class_map[clas][obj.disprock]=obj}
class_unregister(clas,obj)
{if(!obj.disprock||this.class_map[clas][obj.disprock]==null)
{throw new Error('class_unregister: object is not registered')}
delete this.class_map[clas][obj.disprock]
obj.disprock=null}
get_retained_array(arr)
{return{arg:dummyArgInt,arr:arr.slice(),len:arr.length,}}
prepare_resume()
{}
retain_array()
{}
set_vm(vm)
{this.vm=vm}
unretain_array()
{}}
if(typeof module==='object'&&module.exports)
{module.exports=ZVMDispatch}
if(typeof window!=='undefined')
{window.GiDispa=new ZVMDispatch()}
GiLoad=function(){var all_options={vm:null,io:null,spacing:4,use_query_story:true,default_story:null,set_page_title:true,default_page_title:'Game',game_format_name:'',exit_warning:'The game session has ended.',image_info_map:null,proxy_url:'http://zcode.appspot.com/proxy/'};var gameurl=null;var metadata={};var debug_info=null;var blorbchunks={};var alttexts={};function load_run(optobj,image,imageoptions){if(!imageoptions){imageoptions={};}
else if(typeof(imageoptions)=='string'){imageoptions={format:imageoptions};}
else{}
var image_format=imageoptions.format;if(!image_format)
image_format='array';all_options.io=window.Glk;all_options.vm=window.Quixe;if(!optobj)
optobj=window.game_options;if(optobj&&window.Quixe&&((!optobj.vm)||optobj.vm===window.Quixe)){all_options.engine_name='Quixe';all_options.blorb_gamechunk_type='GLUL';all_options.game_format_name='Glulx';}
if(optobj)
jQuery.extend(all_options,optobj);if(all_options.image_info_map!=undefined){if(jQuery.type(all_options.image_info_map)==='string'){if(window[all_options.image_info_map])
all_options.image_info_map=window[all_options.image_info_map];else
delete all_options.image_info_map;}}
gameurl=null;if(all_options.use_query_story){var qparams=get_query_params();gameurl=qparams['story'];}
if(!gameurl&&image){GlkOte.log('GiLoad: trying pre-loaded load ('+image_format+')...');switch(image_format){case'base64':image=decode_base64(image);break;case'raw':image=decode_text(image);break;case'array':break;default:all_options.io.fatal_error("Could not decode story file data: "+image_format);return;}
start_game(image);return;}
if(!gameurl){gameurl=all_options.default_story;}
if(!gameurl){all_options.io.fatal_error("No story file specified!");return;}
image=null;var xhr=new XMLHttpRequest();var binary_supported=(xhr.overrideMimeType!==undefined);var crossorigin_supported=(xhr.withCredentials!==undefined);xhr=null;var regex_urldomain=/^(file:|(\w+:)?\/\/[^\/?#]+)/;var page_domain=regex_urldomain.exec(location)[0];var data_exec=regex_urldomain.exec(gameurl);var is_relative=data_exec?false:true;var data_domain=data_exec?data_exec[0]:page_domain;var same_origin=(page_domain==data_domain);if(navigator.userAgent.match(/chrome/i)&&data_domain=='file:'){same_origin=false;}
var old_js_url=gameurl.match(/[.]js$/i);GlkOte.log('GiLoad: is_relative='+is_relative+', same_origin='+same_origin+', binary_supported='+binary_supported+', crossorigin_supported='+crossorigin_supported);if(old_js_url&&same_origin){GlkOte.log('GiLoad: trying old-fashioned load...');window.processBase64Zcode=function(val){start_game(decode_base64(val));};jQuery.ajax(gameurl,{'type':'GET',dataType:'script',cache:true,error:function(jqxhr,textstatus,errorthrown){all_options.io.fatal_error("The story could not be loaded. ("+gameurl+"): Error "+textstatus+": "+errorthrown);}});return;}
if(old_js_url){GlkOte.log('GiLoad: trying script load...');window.processBase64Zcode=function(val){start_game(decode_base64(val));};var headls=$('head');if(!headls.length){all_options.io.fatal_error("This page has no <head> element!");return;}
var script=$('<script>',{src:gameurl,'type':"text/javascript"});headls.get(0).appendChild(script.get(0));return;}
if(binary_supported&&same_origin){GlkOte.log('GiLoad: trying binary load...');jQuery.ajax(gameurl,{'type':'GET',beforeSend:function(jqxhr,settings){jqxhr.overrideMimeType('text/plain; charset=x-user-defined');},success:function(response,textstatus,errorthrown){start_game(decode_raw_text(response));},error:function(jqxhr,textstatus,errorthrown){all_options.io.fatal_error("The story could not be loaded. ("+gameurl+"): Error "+textstatus+": "+errorthrown);}});return;}
if(data_domain=='file:'){all_options.io.fatal_error("The story could not be loaded. ("+gameurl+"): A local file cannot be sent to the proxy.");return;}
var absgameurl=gameurl;if(is_relative){absgameurl=absolutize(gameurl);GlkOte.log('GiLoad: absolutize '+gameurl+' to '+absgameurl);}
if(crossorigin_supported){GlkOte.log('GiLoad: trying proxy load... ('+all_options.proxy_url+')');jQuery.ajax(all_options.proxy_url,{'type':'GET',data:{encode:'base64',url:absgameurl},error:function(jqxhr,textstatus,errorthrown){all_options.io.fatal_error("The story could not be loaded. ("+gameurl+"): Error "+textstatus+": "+errorthrown);},success:function(response,textstatus,errorthrown){start_game(decode_base64(response));}});return;}
if(true){var fullurl=all_options.proxy_url+'?encode=base64&callback=processBase64Zcode&url='+absgameurl;GlkOte.log('GiLoad: trying proxy-script load... ('+fullurl+')');window.processBase64Zcode=function(val){start_game(decode_base64(val));};var headls=$('head');if(!headls.length){all_options.io.fatal_error("This page has no <head> element!");return;}
var script=$('<script>',{src:fullurl,'type':"text/javascript"});headls.append(script);return;}
all_options.io.fatal_error("The story could not be loaded. ("+gameurl+"): I don't know how to load this data.");}
function get_query_params(){var map={};var qs=location.search.substring(1,location.search.length);if(qs.length){var args=qs.split('&');qs=qs.replace(/\+/g,' ');for(var ix=0;ix<args.length;ix++){var pair=args[ix].split('=');var name=decodeURIComponent(pair[0]);var value=(pair.length==2)?decodeURIComponent(pair[1]):name;map[name]=value;}}
return map;}
function absolutize(url){if(url.match(/^(file|data|http|https):/i)){return url;}
var div=document.createElement('div');div.innerHTML='<a></a>';div.firstChild.href=url;div.innerHTML=div.innerHTML;return div.firstChild.href;}
function get_metadata(val){return metadata[val];}
function get_debug_info(){return debug_info;}
function get_image_info(val){if(all_options.image_info_map!=undefined){var img=all_options.image_info_map[val];if(img)
return img;}
var chunk=blorbchunks['Pict:'+val];if(chunk){var img={image:val};if(chunk.type=='JPEG')
img.type='jpeg';else if(chunk.type=='PNG ')
img.type='png';else
img.type='????';if(chunk.imagesize===undefined){var imgsize=undefined;if(chunk.type=='JPEG'){imgsize=find_dimensions_jpeg(chunk.content);}
else if(chunk.type=='PNG '){imgsize=find_dimensions_png(chunk.content);}
if(imgsize)
chunk.imagesize=imgsize;}
if(chunk.imagesize){img.width=chunk.imagesize.width;img.height=chunk.imagesize.height;}
var rdtext=alttexts['Pict:'+val];if(rdtext)
img.alttext=rdtext;return img;}
return undefined;}
function get_image_url(val){if(all_options.image_info_map){var img=all_options.image_info_map[val];if(img&&img.url)
return absolutize(img.url);}
var chunk=blorbchunks['Pict:'+val];if(chunk){if(chunk.dataurl)
return chunk.dataurl;var info=get_image_info(val);if(info&&chunk.content){var mimetype='application/octet-stream';if(chunk.type=='JPEG')
mimetype='image/jpeg';else if(chunk.type=='PNG ')
mimetype='image/png';var b64dat=encode_base64(chunk.content);chunk.dataurl='data:'+mimetype+';base64,'+b64dat;return chunk.dataurl;}}
return undefined;}
function find_data_chunk(val){var chunk=blorbchunks['Data:'+val];if(!chunk)
return null;var returntype=chunk.type;if(returntype=='FORM')
returntype='BINA';return{data:chunk.content,type:returntype};}
function unpack_blorb(image,gamechunktype){var len=image.length;var ix;var rindex=[];var result=null;var pos=12;while(pos<len){var chunktype=String.fromCharCode(image[pos+0],image[pos+1],image[pos+2],image[pos+3]);pos+=4;var chunklen=(image[pos+0]<<24)|(image[pos+1]<<16)|(image[pos+2]<<8)|(image[pos+3]);pos+=4;if(chunktype=="RIdx"){var npos=pos;var numchunks=(image[npos+0]<<24)|(image[npos+1]<<16)|(image[npos+2]<<8)|(image[npos+3]);npos+=4;for(ix=0;ix<numchunks;ix++){var chunkusage=String.fromCharCode(image[npos+0],image[npos+1],image[npos+2],image[npos+3]);npos+=4;var chunknum=(image[npos+0]<<24)|(image[npos+1]<<16)|(image[npos+2]<<8)|(image[npos+3]);npos+=4;var chunkpos=(image[npos+0]<<24)|(image[npos+1]<<16)|(image[npos+2]<<8)|(image[npos+3]);npos+=4;rindex.push({usage:chunkusage,num:chunknum,pos:chunkpos});}}
if(chunktype=="IFmd"){var arr=image.slice(pos,pos+chunklen);var dat=encode_utf8_text(arr);var met=$('<metadata>').html(dat);var bibels=met.find('bibliographic').children();if(bibels.length){var el;for(ix=0;ix<bibels.length;ix++){el=bibels[ix];metadata[el.tagName.toLowerCase()]=el.textContent;}}}
if(chunktype=="Dbug"){if(all_options.debug_info_chunk){var arr=image.slice(pos,pos+chunklen);debug_info=arr;}}
if(chunktype=="RDes"){var npos=pos;var numentries=(image[npos+0]<<24)|(image[npos+1]<<16)|(image[npos+2]<<8)|(image[npos+3]);npos+=4;for(ix=0;ix<numentries;ix++){var rdusage=String.fromCharCode.apply(this,image.slice(npos,npos+4));npos+=4;var rdnumber=(image[npos+0]<<24)|(image[npos+1]<<16)|(image[npos+2]<<8)|(image[npos+3]);npos+=4;var rdlen=(image[npos+0]<<24)|(image[npos+1]<<16)|(image[npos+2]<<8)|(image[npos+3]);npos+=4;var rdtext=encode_utf8_text(image.slice(npos,npos+rdlen));npos+=rdlen;alttexts[rdusage+':'+rdnumber]=rdtext;}}
pos+=chunklen;if(pos&1)
pos++;}
for(ix=0;ix<rindex.length;ix++){var el=rindex[ix];pos=el.pos;var chunktype=String.fromCharCode(image[pos+0],image[pos+1],image[pos+2],image[pos+3]);pos+=4;var chunklen=(image[pos+0]<<24)|(image[pos+1]<<16)|(image[pos+2]<<8)|(image[pos+3]);pos+=4;el.type=chunktype;el.len=chunklen;el.content=null;if(el.usage=="Exec"&&el.num==0&&chunktype==gamechunktype){result=image.slice(pos,pos+chunklen);}
else{if(chunktype=="FORM"){el.content=image.slice(pos-8,pos+chunklen);}
else{el.content=image.slice(pos,pos+chunklen);}
blorbchunks[el.usage+':'+el.num]=el;}}
return result;}
function decode_raw_text(str){var arr=Array(str.length);var ix;for(ix=0;ix<str.length;ix++){arr[ix]=str.charCodeAt(ix)&0xFF;}
return arr;}
function encode_utf8_text(arr){var res=[];var ch;var pos=0;while(pos<arr.length){var val0,val1,val2,val3;if(pos>=arr.length)
break;val0=arr[pos];pos++;if(val0<0x80){ch=val0;}
else{if(pos>=arr.length)
break;val1=arr[pos];pos++;if((val1&0xC0)!=0x80)
break;if((val0&0xE0)==0xC0){ch=(val0&0x1F)<<6;ch|=(val1&0x3F);}
else{if(pos>=arr.length)
break;val2=arr[pos];pos++;if((val2&0xC0)!=0x80)
break;if((val0&0xF0)==0xE0){ch=(((val0&0xF)<<12)&0x0000F000);ch|=(((val1&0x3F)<<6)&0x00000FC0);ch|=(((val2&0x3F))&0x0000003F);}
else if((val0&0xF0)==0xF0){if(pos>=arr.length)
break;val3=arr[pos];pos++;if((val3&0xC0)!=0x80)
break;ch=(((val0&0x7)<<18)&0x1C0000);ch|=(((val1&0x3F)<<12)&0x03F000);ch|=(((val2&0x3F)<<6)&0x000FC0);ch|=(((val3&0x3F))&0x00003F);}
else{break;}}}
res.push(ch);}
return String.fromCharCode.apply(this,res);}
if(window.atob){decode_base64=function(base64data){var data=atob(base64data);var image=Array(data.length);var ix;for(ix=0;ix<data.length;ix++)
image[ix]=data.charCodeAt(ix);return image;}}
else{var b64decoder=(function(){var b64encoder="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var out=[];var ix;for(ix=0;ix<b64encoder.length;ix++)
out[b64encoder.charAt(ix)]=ix;return out;})();decode_base64=function(base64data){var out=[];var c1,c2,c3,e1,e2,e3,e4;var i=0,len=base64data.length;while(i<len){e1=b64decoder[base64data.charAt(i++)];e2=b64decoder[base64data.charAt(i++)];e3=b64decoder[base64data.charAt(i++)];e4=b64decoder[base64data.charAt(i++)];c1=(e1<<2)+(e2>>4);c2=((e2&15)<<4)+(e3>>2);c3=((e3&3)<<6)+e4;out.push(c1,c2,c3);}
if(e4==64)
out.pop();if(e3==64)
out.pop();return out;}}
var encode_base64;var decode_base64;if(window.btoa){encode_base64=function(image){var blocks=[];var imglen=image.length;for(var ix=0;ix<imglen;ix+=16384){blocks.push(String.fromCharCode.apply(String,image.slice(ix,ix+16384)));}
return btoa(blocks.join(''));};}
else{encode_base64=function(arr){var coder="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var res=[];var byte0,byte1,byte2;for(var ix=0;ix<arr.length;ix+=3){byte0=arr[ix];byte1=arr[ix+1];byte2=arr[ix+2];res.push(coder.charAt((byte0>>2)&0x3F));res.push(coder.charAt(((byte0<<4)&0x30)|((byte1>>4)&0x0F)));res.push(coder.charAt(((byte1<<2)&0x3C)|((byte2>>6)&0x03)));res.push(coder.charAt((byte2)&0x3F));}
if(byte1===undefined&&res.length>=2){res[res.length-2]='=';}
if(byte2===undefined&&res.length>=1){res[res.length-1]='=';}
return res.join('');}}
function find_dimensions_png(arr){var pos=0;if(arr[0]!=0x89||String.fromCharCode.apply(this,arr.slice(1,4))!='PNG'){GlkOte.log('find_dimensions_png: PNG signature does not match');return undefined;}
pos+=8;while(pos<arr.length){var chunklen=(arr[pos+0]<<24)|(arr[pos+1]<<16)|(arr[pos+2]<<8)|(arr[pos+3]);pos+=4;var chunktype=String.fromCharCode.apply(this,arr.slice(pos,pos+4));pos+=4;if(chunktype=='IHDR'){var res={};res.width=(arr[pos+0]<<24)|(arr[pos+1]<<16)|(arr[pos+2]<<8)|(arr[pos+3]);pos+=4;res.height=(arr[pos+0]<<24)|(arr[pos+1]<<16)|(arr[pos+2]<<8)|(arr[pos+3]);pos+=4;return res;}
pos+=chunklen;pos+=4;}
GlkOte.log('find_dimensions_png: no PNG header block found');return undefined;}
function find_dimensions_jpeg(arr){var pos=0;while(pos<arr.length){if(arr[pos]!=0xFF){GlkOte.log('find_dimensions_jpeg: marker is not 0xFF');return undefined;}
while(arr[pos]==0xFF)
pos+=1;var marker=arr[pos];pos+=1;if(marker==0x01||(marker>=0xD0&&marker<=0xD9)){continue;}
var chunklen=(arr[pos+0]<<8)|(arr[pos+1]);if(marker>=0xC0&&marker<=0xCF&&marker!=0xC8){if(chunklen<7){GlkOte.log('find_dimensions_jpeg: SOF block is too small');return undefined;}
var res={};res.height=(arr[pos+3]<<8)|(arr[pos+4]);res.width=(arr[pos+5]<<8)|(arr[pos+6]);return res;}
pos+=chunklen;}
GlkOte.log('find_dimensions_jpeg: no SOF marker found');return undefined;}
function start_game(image){if(image.length==0){all_options.io.fatal_error("No game file was loaded. (Zero-length response.)");return;}
if(image[0]==0x46&&image[1]==0x4F&&image[2]==0x52&&image[3]==0x4D){var formtype=String.fromCharCode(image[8],image[9],image[10],image[11]);if(formtype=='IFZS'){all_options.io.fatal_error("This is a saved-game file, not a "+all_options.game_format_name+" game file. You must launch the game first, then restore your save.");return;}
if(formtype!='IFRS'){all_options.io.fatal_error("This IFF file is not a Blorb file!");return;}
if(all_options.blorb_gamechunk_type){try{image=unpack_blorb(image,all_options.blorb_gamechunk_type);}
catch(ex){all_options.io.fatal_error("Blorb file could not be parsed: "+ex);return;}}
if(!image){all_options.io.fatal_error("Blorb file contains no "+all_options.game_format_name+" game!");return;}}
{var title=null;if(metadata)
title=metadata.title;if(!title&&gameurl)
title=gameurl.slice(gameurl.lastIndexOf("/")+1);if(!title)
title=all_options.default_page_title;if(!title)
title='Game';if(!all_options.recording_label)
all_options.recording_label=title;if(all_options.set_page_title)
document.title=title+" - "+all_options.engine_name;}
all_options.vm.prepare(image,all_options);all_options.io.init(all_options);}
return{load_run:load_run,find_data_chunk:find_data_chunk,get_metadata:get_metadata,get_debug_info:get_debug_info,get_image_info:get_image_info,get_image_url:get_image_url};}();