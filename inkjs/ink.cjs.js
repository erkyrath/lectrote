"use strict";var babelHelpers={};babelHelpers["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},babelHelpers.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},babelHelpers.createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}}(),babelHelpers["extends"]=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},babelHelpers.inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},babelHelpers.possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e};var Path$1=function(){function t(){babelHelpers.classCallCheck(this,t),this._isRelative,this._components=[],"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof Component&&arguments[1]instanceof t?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1])):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1])}return babelHelpers.createClass(t,[{key:"PathByAppendingPath",value:function(e){for(var n=new t,a=0,r=0;r<e.components.length&&e.components[r].isParent;++r)a++;for(var r=0;r<this.components.length-a;++r)n.components.push(this.components[r]);for(var r=a;r<e.components.length;++r)n.components.push(e.components[r]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){return null==t?!1:t.components.length!=this.components.length?!1:t.isRelative!=this.isRelative?!1:t.components==this.components}},{key:"isRelative",get:function(){return this._isRelative}},{key:"components",get:function(){return this._components}},{key:"head",get:function(){return this.components.length>0?this.components[0]:null}},{key:"tail",get:function(){if(this.components.length>=2){var e=this.components.slice(1,this.components.length);return new t(e)}return t.self}},{key:"length",get:function(){return this.components.length}},{key:"lastComponent",get:function(){return this.components.length>0?this.components[this.components.length-1]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this.components.length;e>t;t++)if(!this.components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){var t=this.components.join(".");return this.isRelative?"."+t:t},set:function(t){var e=this;this.components.length=0;var n=t;if(null!=n&&""!=n){"."==n[0]&&(this._isRelative=!0,n=n.substring(1));var a=n.split(".");a.forEach(function(t){isNaN(parseInt(t))?e.components.push(new Component(t)):e.components.push(new Component(parseInt(t)))})}}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}(),Component=function(){function t(e){babelHelpers.classCallCheck(this,t),"string"==typeof e?(this._index=-1,this._name=e):(this._index=parseInt(e),this._name=null)}return babelHelpers.createClass(t,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex?this.isIndex?this.index==t.index:this.name==t.name:!1}},{key:"index",get:function(){return this._index}},{key:"name",get:function(){return this._name}},{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==Path$1.parentId}}],[{key:"ToParent",value:function(){return new t(Path$1.parentId)}}]),t}();Path$1.parentId="^",Path$1.Component=Component;var InkObject=function(){function t(){babelHelpers.classCallCheck(this,t),this.parent=null,this._path=null}return babelHelpers.createClass(t,[{key:"ResolvePath",value:function(t){if(t.isRelative){var e=this;return e instanceof Container==!1&&(null==this.parent&&console.warn("Can't resolve relative path because we don't have a parent"),e=this.parent,"Container"!==e.constructor.name&&console.warn("Expected parent to be a container"),t=t.tail),e.ContentAtPath(t)}return this.rootContentContainer.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.components.length,e.components.length),a=-1,r=0;n>r;++r){var i=e.components[r],o=t.components[r];if(!i.Equals(o))break;a=r}if(-1==a)return t;for(var s=e.components.length-1-a,u=[],l=0;s>l;++l)u.push(Path$1.Component.ToParent());for(var h=a+1;h<t.components.length;++h)u.push(t.components[h]);var c=new Path$1(u,!0);return c}},{key:"CompactPathString",value:function(t){var e=null,n=null;if(t.isRelative)n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString;else{var a=this.ConvertPathToRelative(t);n=a.componentsString,e=t.componentsString}return n.Length<e.Length?n:e}},{key:"Copy",value:function(){throw"Not Implemented"}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new Path$1;else{for(var t=[],e=this,n=e.parent;n instanceof Container;){var a=e;a.name&&a.hasValidName?t.unshift(new Path$1.Component(a.name)):t.unshift(new Path$1.Component(n.content.indexOf(e))),e=n,n=n.parent}this._path=new Path$1(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return t}}]),t}(),ValueType={Int:0,Float:1,String:2,DivertTarget:3,VariablePointer:4},AbstractValue=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n._valueType,n._isTruthy,n._valueObject,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Cast",value:function(t){throw"Trying to casting an AbstractValue"}},{key:"Copy",value:function(t){return this.Create(t)}},{key:"valueType",get:function(){return this._valueType}},{key:"isTruthy",get:function(){return this._isTruthy}},{key:"valueObject",get:function(){return this._valueObject}}],[{key:"Create",value:function(t){if(t instanceof Boolean){var e=!!t;t=e?1:0}return Number.isInteger(Number(t))?new IntValue(t):isNaN(t)?t instanceof String?new StringValue(t):t instanceof Path$1?new DivertTargetValue(t):null:new FloatValue(t)}}]),e}(InkObject),Value=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n.value=t,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"toString",value:function(){return this.value.toString()}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}},{key:"valueObject",get:function(){return this.value}}]),e}(AbstractValue),IntValue=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t||0));return n._valueType=ValueType.Int,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==ValueType.Float)return new FloatValue(parseFloat(this.value));if(t==ValueType.String)return new StringValue(""+this.value);throw"Unexpected type cast of Value to new ValueType"}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return ValueType.Int}}]),e}(Value),FloatValue=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t||0));return n._valueType=ValueType.Float,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==ValueType.Int)return new IntValue(parseInt(this.value));if(t==ValueType.String)return new StringValue(""+this.value);throw"Unexpected type cast of Value to new ValueType"}},{key:"isTruthy",get:function(){return 0!=this._value}},{key:"valueType",get:function(){return ValueType.Float}}]),e}(Value),StringValue=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t||""));return n._valueType=ValueType.String,n._isNewline="\n"==n.value,n._isInlineWhitespace=!0,n.value.split().every(function(t){return" "!=t&&"	"!=t?(n._isInlineWhitespace=!1,!1):!0}),n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==ValueType.Int){var e;return(e=parseInt(value))?new IntValue(e):null}if(t==ValueType.Float){var n;return(n=n(value))?new FloatValue(n):null}throw"Unexpected type cast of Value to new ValueType"}},{key:"valueType",get:function(){return ValueType.String}},{key:"isTruthy",get:function(){return this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),e}(Value),DivertTargetValue=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._valueType=ValueType.DivertTarget,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"targetPath",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a divert target"}}]),e}(Value),VariablePointerValue=function(t){function e(t,n){babelHelpers.classCallCheck(this,e);var a=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return a._valueType=ValueType.VariablePointer,a.contextIndex="undefined"!=typeof n?n:-1,a}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}},{key:"variableName",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a variable pointer"}}]),e}(Value),StoryException=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.message=t,n.name="StoryException",n}return babelHelpers.inherits(e,t),e}(Error),Container=function(t){function e(){babelHelpers.classCallCheck(this,e);var t=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return t.name="",t._content=[],t.namedContent={},t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t.CountFlags={Visits:1,Turns:2,CountStartOnly:4},t._pathToFirstLeafContent=null,t}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"AddContent",value:function(t){var e=this;if(t instanceof Array)t.forEach(function(t){e.AddContent(t)});else{if(this._content.push(t),t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}}},{key:"TryAddNamedContent",value:function(t){t.hasValidName&&t.name&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(t){t instanceof InkObject==!1&&console.warn("Can only add Runtime.Objects to a Runtime.Container"),t.parent=this,this.namedContent[t.name]=t}},{key:"ContentAtPath",value:function(t,n){n="undefined"!=typeof n?n:t.components.length;for(var a=this,r=this,i=0;n>i;++i){var o=t.components[i];if(!(a instanceof e))throw"Path continued, but previous object wasn't a container: "+r;r=a.ContentWithPathComponent(o),a=r}return r}},{key:"InsertContent",value:function(t,e){if(this.content[i]=t,t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e=this;this.content=this.content.concat(t.content),t.content.forEach(function(t){t.parent=e,e.TryAddNamedContent(t)})}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;var e=null;if(e=this.namedContent[t.name])return e;throw new StoryException("Content '"+t.name+"' not found at path: '"+this.path+"'")}},{key:"BuildStringOfHierarchy",value:function(t,n,a){function r(){for(var e=4,a=0;e*n>a;++a)t+=" "}if(0==arguments.length)return this.BuildStringOfHierarchy("",0,null);r(),t+="[",this.hasValidName&&(t+=" ("+this.name+")"),this==a&&(t+="  <---"),t+="\n",n++;for(var i=0;i<this.content.length;++i){var o=this.content[i];if(o instanceof e){var s=o;s.BuildStringOfHierarchy(t,n,a)}else r(),o instanceof StringValue?(t+='"',t+=o.toString().replace("\n","\\n"),t+='"'):t+=o.toString();i!=this.content.length-1&&(t+=","),o instanceof e||o!=a||(t+="  <---"),t+="\n"}var u={};for(var l in this.namedContent)this.content.indexOf(this.namedContent[l])>=0||(u[l]=this.namedContent[l]);if(Object.keys(u).length>0){r(),t+="\n",t+="-- named: --";for(var l in u){u[l]instanceof e||console.warn("Can only print out named Containers");var s=u[l];s.BuildStringOfHierarchy(t,n,a),t+="\n"}}n--,r(),t+="]"}},{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t={};for(var e in this.namedContent)t[e]=this.namedContent[e];return this.content.forEach(function(e){var n=e;n.name&&n.hasValidName&&delete t[n.name]}),0==t.length&&(t=null),t},set:function(t){var e=this.namedOnlyContent;if(null!=e)for(var n in e)delete this.namedContent[n];if(null!=t)for(var n in t){var a=t[n];a.name&&"undefined"!=typeof a.hasValidName&&this.AddToNamedContentOnly(a)}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=this.CountFlags.Turns),this.countingAtStartOnly&&(t|=this.CountFlags.CountStartOnly),t==this.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&this.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&this.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&this.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=new Path,n=this;n instanceof e;)n.content.length>0&&(t.components.push(new Path.Component(0)),n=n.content[0]);return t}}]),e}(InkObject),Glue=function(){function t(e){babelHelpers.classCallCheck(this,t),this.glueType=e}return babelHelpers.createClass(t,[{key:"toString",value:function(){switch(this.glueType){case GlueType.Bidirectional:return"BidirGlue";case GlueType.Left:return"LeftGlue";case GlueType.Right:return"RightGlue"}return"UnexpectedGlueType"}},{key:"isLeft",get:function(){return this.glueType==GlueType.Left}},{key:"isBi",get:function(){return this.glueType==GlueType.Bidirectional}},{key:"isRight",get:function(){return this.glueType==GlueType.Right}}]),t}(),GlueType={Bidirectional:0,Left:1,Right:2},ControlCommand=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n._commandType="undefined"!=typeof t?t:CommandType.NotSet,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new e(CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new e(CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new e(CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new e(CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new e(CommandType.BeginString)}},{key:"EndString",value:function(){return new e(CommandType.EndString)}},{key:"NoOp",value:function(){return new e(CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new e(CommandType.ChoiceCount)}},{key:"TurnsSince",value:function(){return new e(CommandType.TurnsSince)}},{key:"VisitIndex",value:function(){return new e(CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(CommandType.StartThread)}},{key:"Done",value:function(){return new e(CommandType.Done)}},{key:"End",value:function(){return new e(CommandType.End)}}]),e}(InkObject),CommandType={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,VisitIndex:12,SequenceShuffleIndex:13,StartThread:14,Done:15,End:16};CommandType.TOTAL_VALUES=Object.keys(CommandType).length-1,ControlCommand.CommandType=CommandType;var PushPopType={Tunnel:0,Function:1},Divert=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n._targetPath,n._targetContent,n.variableDivertName,n.pushesToStack,n.stackPushType,n.isExternal,n.isConditional,n.externalArgs,n.pushesToStack=!1,t&&(n.pushesToStack=!0,n.stackPushType=t),n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Equals",value:function(t){var n=t;return n instanceof e&&this.hasVariableTarget==n.hasVariableTarget?this.hasVariableTarget?this.variableDivertName==n.variableDivertName:this.targetPath.Equals(n.targetPath):!1}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t="",e=this.targetPath.toString(),n=null;return null!=n&&(e="line "+n),t+="Divert",this.pushesToStack&&(t+=this.stackPushType==PushPopType.Function?" function":" tunnel"),t+=" (",t+=e,t+=")"}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetContent;t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetContent=null}},{key:"targetContent",get:function(){return null==this._targetContent&&(this._targetContent=this.ResolvePath(this._targetPath)),this._targetContent}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){null==t?this.targetPath=null:this.targetPath=new Path$1(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),e}(InkObject),ChoicePoint=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n.pathOnChoice,n.hasCondition,n.hasStartContent,n.hasChoiceOnlyContent,n.onceOnly,n.isInvisibleDefault,n.onceOnly=!!t,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"toString",value:function(){var t=null,e=this.pathOnChoice.toString();return null!=t&&(e=" line "+t),"Choice: -> "+e}},{key:"choiceTarget",get:function(){return this.ResolvePath(this.pathOnChoice)}},{key:"pathStringOnChoice",get:function(){return this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new Path$1(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}}]),e}(InkObject),VariableReference=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n.name=t,n.pathForCount,n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"toString",value:function(){if(null!=this.name)return"var("+this.name+")";var t=this.pathStringForCount;return"read_count("+t+")"}},{key:"containerForCount",get:function(){return this.ResolvePath(this.pathForCount)}},{key:"pathStringForCount",get:function(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){null==t?this.pathForCount=null:this.pathForCount=new Path$1(t)}}]),e}(InkObject),VariableAssignment=function(t){function e(t,n){babelHelpers.classCallCheck(this,e);var a=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return a._variableName=t||null,a._isNewDeclaration=!!n,a.isGlobal,a}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}},{key:"variableName",get:function(){return this._variableName}},{key:"isNewDeclaration",get:function(){return this._isNewDeclaration}}]),e}(InkObject),Void=function(t){function e(){return babelHelpers.classCallCheck(this,e),babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return babelHelpers.inherits(e,t),e}(InkObject),NativeFunctionCall=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return n.name=t,n._numberOfParameters,n._prototype,n._isPrototype,n._operationFuncs=null,e.GenerateNativeFunctionsIfNecessary(),n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw"Unexpected number of parameters";t.forEach(function(t){if(t instanceof Void)throw new StoryException("Attempting to perform operation on a void value. Did you forget to 'return' a value from a function you called here?")});var e=this.CoerceValuesToSingleType(t),n=e[0].valueType;return n==ValueType.Int?this.CallType(e):n==ValueType.Float?this.CallType(e):n==ValueType.String?this.CallType(e):n==ValueType.DivertTarget?this.CallType(e):null}},{key:"CallType",value:function(t){var e=t[0],n=e.valueType,a=e,r=t.length;if(2==r||1==r){var i=this._operationFuncs[n];if(!i)throw new StoryException("Can not perform operation '"+this.name+"' on "+n);if(2==r){var o=t[1],s=o,u=i,l=u(a.value,s.value);return Value.Create(l)}var u=i,l=u(a.value);return Value.Create(l)}throw"Unexpected number of parameters to NativeFunctionCall: "+t.length}},{key:"CoerceValuesToSingleType",value:function(t){var e=ValueType.Int;t.forEach(function(t){var n=t;n.valueType>e&&(e=n.valueType)});var n=[];return t.forEach(function(t){var a=t.Cast(e);n.push(a)}),n}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[t]=e}},{key:"toString",value:function(){return"Native '"+this.name+"'"}},{key:"name",get:function(){return this._name},set:function(t){this._name=t,this._isPrototype||(this._prototype=e._nativeFunctions[this._name])}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"internalConstructor",value:function(t,n){var a=new e(t);return a._isPrototype=!0,a.numberOfParameters=n,a}},{key:"CallWithName",value:function(t){return new e(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[t]}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){if(null==this._nativeFunctions){this._nativeFunctions={},this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return t/e}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return e>t?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return e>=t?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return e>t?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return e>=t?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0});var t=function(t,e){return t.Equals(e)?1:0};this.AddOpToNativeFunc(this.Equal,2,ValueType.DivertTarget,t)}}},{key:"AddOpToNativeFunc",value:function(t,n,a,r){var i=this._nativeFunctions[t];i||(i=e.internalConstructor(t,n),this._nativeFunctions[t]=i),i.AddOpFuncForType(a,r)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,ValueType.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,ValueType.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,ValueType.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,ValueType.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,ValueType.String,e)}}]),e}(InkObject);NativeFunctionCall.Add="+",NativeFunctionCall.Subtract="-",NativeFunctionCall.Divide="/",NativeFunctionCall.Multiply="*",NativeFunctionCall.Mod="%",NativeFunctionCall.Negate="~",NativeFunctionCall.Equal="==",NativeFunctionCall.Greater=">",NativeFunctionCall.Less="<",NativeFunctionCall.GreaterThanOrEquals=">=",NativeFunctionCall.LessThanOrEquals="<=",NativeFunctionCall.NotEquals="!=",NativeFunctionCall.Not="!",NativeFunctionCall.And="&&",NativeFunctionCall.Or="||",NativeFunctionCall.Min="MIN",NativeFunctionCall.Max="MAX",NativeFunctionCall._nativeFunctions=null;var Choice=function(){function t(e){babelHelpers.classCallCheck(this,t),this.text,this.index,this.choicePoint,this.threadAtGeneration,this._originalThreadIndex,this._originalChoicePath,e&&(this.choicePoint=e)}return babelHelpers.createClass(t,[{key:"pathStringOnChoice",get:function(){return this.choicePoint.pathStringOnChoice}}]),t}(),JsonSerialisation=function(){function t(){babelHelpers.classCallCheck(this,t)}return babelHelpers.createClass(t,null,[{key:"ListToJArray",value:function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.RuntimeObjectToJToken(t))}),n}},{key:"JArrayToRuntimeObjList",value:function(t,e){var n=t.length;e&&n--;for(var a=[],r=0;n>r;r++){var i=t[r],o=this.JTokenToRuntimeObject(i);a.push(o)}return a}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e={};for(var n in t)e[n]=this.JTokenToRuntimeObject(t[n]);return e}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={};for(var n in t){var a=t[n];a instanceof InkObject&&(e[n]=this.RuntimeObjectToJToken(a))}return e}},{key:"JObjectToIntDictionary",value:function(t){var e={};for(var n in t)e[n]=parseInt(t[n]);return e}},{key:"IntDictionaryToJObject",value:function(t){var e={};for(var n in t)e[n]=t[n];return e}},{key:"JTokenToRuntimeObject",value:function(t){if(!isNaN(t)&&"\n"!==t)return Value.Create(t);if("string"==typeof t){var e=t.toString(),n=e[0];if("^"==n)return new StringValue(e.substring(1));if("\n"==n&&1==e.length)return new StringValue("\n");if("<>"==e)return new Glue(GlueType.Bidirectional);if("G<"==e)return new Glue(GlueType.Left);if("G>"==e)return new Glue(GlueType.Right);for(var a=0;a<_controlCommandNames.length;++a){var r=_controlCommandNames[a];if(e==r)return new ControlCommand(a)}if(NativeFunctionCall.CallExistsWithName(e))return NativeFunctionCall.CallWithName(e);if("->->"==e)return ControlCommand.PopTunnel();if("~ret"==e)return ControlCommand.PopFunction();if("void"==e)return new Void}if("object"===("undefined"==typeof t?"undefined":babelHelpers["typeof"](t))&&t instanceof Array==!1){var i,o=t;if(o["^->"])return i=o["^->"],new DivertTargetValue(new Path$1(i.toString()));if(o["^var"]){i=o["^var"];var s=new VariablePointerValue(i.toString());return o.ci&&(i=o.ci,s.contextIndex=parseInt(i)),s}var u=!1,l=!1,h=PushPopType.Function,c=!1;if((i=o["->"])?u=!0:(i=o["f()"])?(u=!0,l=!0,h=PushPopType.Function):(i=o["->t->"])?(u=!0,l=!0,h=PushPopType.Tunnel):(i=o["x()"])&&(u=!0,c=!0,l=!1,h=PushPopType.Function),u){var f=new Divert;f.pushesToStack=l,f.stackPushType=h,f.isExternal=c;var p=i.toString();return(i=o["var"])?f.variableDivertName=p:f.targetPathString=p,f.isConditional=!!o.c,c&&(i=o.exArgs)&&(f.externalArgs=parseInt(i)),f}if(i=o["*"]){var v=new ChoicePoint;return v.pathStringOnChoice=i.toString(),(i=o.flg)&&(v.flags=parseInt(i)),v}if(i=o["VAR?"])return new VariableReference(i.toString());if(i=o["CNT?"]){var d=new VariableReference;return d.pathStringForCount=i.toString(),d}var C=!1,y=!1;if((i=o["VAR="])?(C=!0,y=!0):(i=o["temp="])&&(C=!0,y=!1),C){var m=i.toString(),b=!o.re,g=new VariableAssignment(m,b);return g.isGlobal=y,g}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(t instanceof Array)return this.JArrayToContainer(t);if(null==t)return null;throw"Failed to convert token to runtime object: "+JSON.stringify(t)}},{key:"RuntimeObjectToJToken",value:function(t){var e=t;if(e instanceof Container)return this.ContainerToJArray(e);var n=t;if(n instanceof Divert){var a="->";n.isExternal?a="x()":n.pushesToStack&&(n.stackPushType==PushPopType.Function?a="f()":n.stackPushType==PushPopType.Tunnel&&(a="->t->"));
var r;r=n.hasVariableTarget?n.variableDivertName:n.targetPathString;var i={};return i[a]=r,n.hasVariableTarget&&(i["var"]=!0),n.isConditional&&(i.c=!0),n.externalArgs>0&&(i.exArgs=n.externalArgs),i}var o=t;if(o instanceof ChoicePoint){var i={};return i["*"]=o.pathStringOnChoice,i.flg=o.flags,i}var s=t;if(s instanceof IntValue)return s.value;var u=t;if(u instanceof FloatValue)return u.value;var l=t;if(l instanceof StringValue)return l.isNewline?"\n":"^"+l.value;var h=t;if(h instanceof DivertTargetValue)return{"^->":h.value.componentsString};var c=t;if(c instanceof VariablePointerValue)return{"^var":c.value,ci:c.contextIndex};var f=t;if(f instanceof Glue)return f.isBi?"<>":f.isLeft?"G<":"G>";var p=t;if(p instanceof ControlCommand)return _controlCommandNames[parseInt(p.commandType)];var v=t;if(v instanceof NativeFunctionCall)return v.name;var d=t;if(d instanceof VariableReference){var i={},C=d.pathStringForCount;return null!=C?i["CNT?"]=C:i["VAR?"]=d.name,i}var y=t;if(y instanceof VariableAssignment){var m=y.isGlobal?"VAR=":"temp=",i={};return i[m]=y.variableName,y.isNewDeclaration||(i.re=!0),i}var b=t;if(b instanceof Void)return"void";var g=t;if(g instanceof Choice)return this.ChoiceToJObject(g);throw"Failed to convert runtime object to Json token: "+t}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,a=t.countFlags;if(null!=n&&n.length>0||a>0||null!=t.name){var r;null!=n?(r=this.DictionaryRuntimeObjsToJObject(n),r.forEach(function(t){var e=t.Value;if(null!=e){var n=e[e.length-1];if(null!=n)throw"Cleaning attrJObj not implemented"}})):r={},a>0&&(r["#f"]=a),null!=t.name&&(r["#n"]=t.name),e.push(r)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new Container;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var a={};for(var r in n)if("#f"==r)e.countFlags=parseInt(n[r]);else if("#n"==r)e.name=n[r].toString();else{var i=this.JTokenToRuntimeObject(n[r]),o=i;o instanceof Container&&(o.name=r),a[r]=i}e.namedOnlyContent=a}return e}},{key:"JObjectToChoice",value:function(t){var e=new Choice;return e.text=t.text.toString(),e.index=parseInt(t.index),e.originalChoicePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.originalChoicePath,e.originalThreadIndex=t.originalThreadIndex,e}}]),t}(),_controlCommandNames=[];_controlCommandNames[ControlCommand.CommandType.EvalStart]="ev",_controlCommandNames[ControlCommand.CommandType.EvalOutput]="out",_controlCommandNames[ControlCommand.CommandType.EvalEnd]="/ev",_controlCommandNames[ControlCommand.CommandType.Duplicate]="du",_controlCommandNames[ControlCommand.CommandType.PopEvaluatedValue]="pop",_controlCommandNames[ControlCommand.CommandType.PopFunction]="~ret",_controlCommandNames[ControlCommand.CommandType.PopTunnel]="->->",_controlCommandNames[ControlCommand.CommandType.BeginString]="str",_controlCommandNames[ControlCommand.CommandType.EndString]="/str",_controlCommandNames[ControlCommand.CommandType.NoOp]="nop",_controlCommandNames[ControlCommand.CommandType.ChoiceCount]="choiceCnt",_controlCommandNames[ControlCommand.CommandType.TurnsSince]="turns",_controlCommandNames[ControlCommand.CommandType.VisitIndex]="visit",_controlCommandNames[ControlCommand.CommandType.SequenceShuffleIndex]="seq",_controlCommandNames[ControlCommand.CommandType.StartThread]="thread",_controlCommandNames[ControlCommand.CommandType.Done]="done",_controlCommandNames[ControlCommand.CommandType.End]="end";for(var i$1=0;i$1<ControlCommand.CommandType.TOTAL_VALUES;++i$1)if(null==_controlCommandNames[i$1])throw"Control command not accounted for in serialisation";var Element=function(){function t(e,n,a,r){babelHelpers.classCallCheck(this,t),this.currentContainer=n,this.currentContentIndex=a,this.inExpressionEvaluation=r||!1,this.temporaryVariables={},this.type=e}return babelHelpers.createClass(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentContainer,this.currentContentIndex,this.inExpressionEvaluation);return babelHelpers["extends"](e.temporaryVariables,this.temporaryVariables),e}},{key:"currentObject",get:function(){return this.currentContainer&&this.currentContentIndex<this.currentContainer.content.length?this.currentContainer.content[this.currentContentIndex]:null},set:function(t){var e=t;return null==e?(this.currentContainer=null,void(this.currentContentIndex=0)):(this.currentContainer=e.parent,this.currentContainer instanceof Container&&(this.currentContentIndex=this.currentContainer.content.indexOf(e)),void(this.currentContainer instanceof Container!=!1&&-1!=this.currentContentIndex||(this.currentContainer=e,this.currentContentIndex=0)))}}]),t}(),Thread=function(){function t(e,n){var a=this;if(babelHelpers.classCallCheck(this,t),this.callstack=[],this.threadIndex=0,this.previousContentObject=null,e&&n){var r=e;this.threadIndex=parseInt(r.threadIndex);var i=r.callstack;i.forEach(function(t){var e=t,r=parseInt(e.type),i=null,o=0,s=null,u=e.cPath;"undefined"!=typeof u&&(s=u.toString(),i=n.ContentAtPath(new Path$1(s)),o=parseInt(e.idx));var l=!!e.exp,h=new Element(r,i,o,l),c=e.temp;h.temporaryVariables=JsonSerialisation.JObjectToDictionaryRuntimeObjs(c),a.callstack.push(h)});var o=r.previousContentObject;if("undefined"!=typeof o){var s=new Path$1(o.toString());this.previousContentObject=n.ContentAtPath(s)}}}return babelHelpers.createClass(t,[{key:"Copy",value:function(){var e=new t;return e.threadIndex=this.threadIndex,this.callstack.forEach(function(t){e.callstack.push(t.Copy())}),e.previousContentObject=this.previousContentObject,e}},{key:"jsonToken",get:function(){var t={},e=[];return this.callstack.forEach(function(t){var n={};t.currentContainer&&(n.cPath=t.currentContainer.path.componentsString,n.idx=t.currentContentIndex),n.exp=t.inExpressionEvaluation,n.type=parseInt(t.type),n.temp=JsonSerialisation.DictionaryRuntimeObjsToJObject(t.temporaryVariables),e.push(n)}),t.callstack=e,t.threadIndex=this.threadIndex,null!=this.previousContentObject&&(t.previousContentObject=this.previousContentObject.path.toString()),t}}]),t}(),CallStack=function(){function t(e){var n=this;babelHelpers.classCallCheck(this,t),this._threads=[],this._threadCounter=0,this._threads.push(new Thread),e instanceof t?(this._threads=[],e._threads.forEach(function(t){n._threads.push(t.Copy())})):this._threads[0].callstack.push(new Element(PushPopType.Tunnel,e,0))}return babelHelpers.createClass(t,[{key:"CanPop",value:function(t){return this.canPop?null==t?!0:this.currentElement.type==t:!1}},{key:"Pop",value:function(t){return this.CanPop(t)?void this.callStack.pop():void console.error("Mismatched push/pop in Callstack")}},{key:"Push",value:function(t){this.callStack.push(new Element(t,this.currentElement.currentContainer,this.currentElement.currentContentIndex,!1))}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();t.threadIndex=this._threadCounter,this._threadCounter++,this._threads.push(t)}},{key:"PopThread",value:function(){this.canPopThread?this._threads.splice(this._threads.indexOf(this.currentThread),1):console.error("Can't pop thread")}},{key:"SetJsonToken",value:function(t,e){var n=this;this._threads.length=0;var a=t,r=a.threads;r.forEach(function(t){var a=new Thread(t,e);n._threads.push(a)}),this._threadCounter=parseInt(a.threadCounter)}},{key:"GetJsonToken",value:function(){var t={},e=[];return this._threads.forEach(function(t){e.push(t.jsonToken)}),t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"GetTemporaryVariableWithName",value:function(t,e){e="undefined"==typeof e?-1:e,-1==e&&(e=this.currentElementIndex+1);var n=null,a=this.callStack[e-1];return(n=a.temporaryVariables[t])?n:null}},{key:"SetTemporaryVariable",value:function(t,e,n,a){a="undefined"==typeof a?-1:a,-1==a&&(a=this.currentElementIndex+1);var r=this.callStack[a-1];if(!n&&!r.temporaryVariables[t])throw new StoryException("Could not find temporary variable to set: "+t);r.temporaryVariables[t]=e}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables[t]?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){var e=this._threads.filter(function(e){return e.threadIndex==t?e:void 0});return e[0]}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){1!=this._threads.length&&console.warn("Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"elements",get:function(){return this.callStack}},{key:"currentElement",get:function(){return this.callStack[this.callStack.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"canPopThread",get:function(){return this._threads.length>1}}]),t}(),VariablesState=function(){function t(e){babelHelpers.classCallCheck(this,t),this._globalVariables={},this._callStack=e,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{var n=new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}});return n}catch(a){}}return babelHelpers.createClass(t,[{key:"ObserveVariableChange",value:function(t){var e=this;null==this.variableChangedEvent&&(this.variableChangedEvent=function(t,n){e.variableChangedEventCallbacks.forEach(function(e){e(t,n)})}),this.variableChangedEventCallbacks.push(t)}},{key:"CopyFrom",value:function(t){this._globalVariables=t._globalVariables,this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(t.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=t._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null))}},{key:"GetVariableWithName",value:function(t,e){"undefined"==typeof e&&(e=-1);var n=this.GetRawVariableWithName(t,e),a=n;return a instanceof VariablePointerValue&&(n=this.ValueAtVariablePointer(a)),n}},{key:"GetRawVariableWithName",value:function(t,e){var n=null;if((0==e||-1==e)&&(n=this._globalVariables[t]))return n;if(n=this._callStack.GetTemporaryVariableWithName(t,e),null==n)throw"RUNTIME ERROR: Variable '"+t+"' could not be found in context '"+e+"'. This shouldn't be possible so is a bug in the ink engine. Please try to construct a minimal story that reproduces the problem and report to inkle, thank you!";return n}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName,a=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:!!this._globalVariables[n],t.isNewDeclaration){var i=e;if(i instanceof VariablePointerValue){var o=this.ResolveVariablePointer(i);e=o}}else{var s=null;do s=this.GetRawVariableWithName(n,a),s instanceof VariablePointerValue&&(n=s.variableName,a=s.contextIndex,r=0==a);while(s instanceof VariablePointerValue)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,a)}},{key:"SetGlobal",value:function(t,e){var n=null;n=this._globalVariables[t],this._globalVariables[t]=e,null!=this.variableChangedEvent&&e!==n&&(this.batchObservingVariableChanges?this._changedVariables.push(t):this.variableChangedEvent(t,e))}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=this.GetRawVariableWithName(t.variableName,e),a=n;return a instanceof VariablePointerValue?a:new VariablePointerValue(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables[t]?0:this._callStack.currentElementIndex}},{key:"$",value:function(t,e){if("undefined"==typeof e){var n=this._globalVariables[t];return"undefined"!=typeof n?n.valueObject:null}var a=Value.Create(e);if(null==a)throw new StoryException(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,a)}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){var e=this;t=!!t,this._batchObservingVariableChanges=t,t?this._changedVariables=[]:(null!=this._changedVariables&&this._changedVariables.forEach(function(t){var n=e._globalVariables[t];e.variableChangedEvent(t,n)}),this._changedVariables=null)}},{key:"jsonToken",get:function(){return JsonSerialisation.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=JsonSerialisation.JObjectToDictionaryRuntimeObjs(t)}}]),t}(),PRNG=function(){function t(e){babelHelpers.classCallCheck(this,t),this._seed=e%2147483647,this._seed<=0&&(this._seed+=2147483646)}return babelHelpers.createClass(t,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),StoryState=function(){function t(e){babelHelpers.classCallCheck(this,t),this.story=e,this._outputStream=[],this._evaluationStack=[],this._callStack=new CallStack(e.rootContentContainer),this._variablesState=new VariablesState(this._callStack),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedTargetObject=null;var n=(new Date).getTime();this._storySeed=n+"-"+Math.round(9999*Math.random()),this._storySeed=new PRNG(n).next()%100,this._currentChoices=[],this._currentErrors=null,this._currentRightGlue,this.didSafeExit=!1,this.GoToStart()}return babelHelpers.createClass(t,[{key:"GoToStart",value:function(){this.callStack.currentElement.currentContainer=this.story.mainContentContainer,this.callStack.currentElement.currentContentIndex=0}},{key:"ResetErrors",value:function(){this._currentErrors=null}},{key:"ResetOutput",value:function(){this._outputStream.length=0}},{key:"PushEvaluationStack",value:function(t){this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(t){if(t>this.evaluationStack.length)throw"trying to pop too many objects";var e=this.evaluationStack.splice(this.evaluationStack.length-t,t);return e}var n=this.evaluationStack.pop();return n}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"PushToOutputStream",value:function(t){var e=this,n=t;if(n instanceof StringValue){var a=this.TrySplittingHeadTailWhitespace(n);if(null!=a)return void a.forEach(function(t){e.PushToOutputStreamIndividual(t)})}this.PushToOutputStreamIndividual(t)}},{key:"TrySplittingHeadTailWhitespace",value:function(t){for(var e=t.value,n=-1,a=-1,r=0;r<e.length;++r){var i=e[r];if("\n"!=i){if(" "==i||"	"==i)continue;break}-1==n&&(n=r),a=r}for(var o=-1,s=-1,r=0;r<e.length;++r){var i=e[r];if("\n"!=i){if(" "==i||"	"==i)continue;break}-1==o&&(o=r),s=r}if(-1==n&&-1==o)return null;var u=[],l=0,h=e.length;if(-1!=n){if(n>0){var c=e.substring(0,n);u.push(c)}u.push(new StringValue("\n")),l=a+1}if(-1!=o&&(h=s),h>l){var f=e.substring(l,h-l);u.push(new StringValue(f))}if(-1!=o&&s>a&&(u.push(new StringValue("\n")),o<e.length-1)){var p=e.Length-o-1,v=new StringValue(e.substring(o+1,p));u.push(v)}return u}},{key:"PushToOutputStreamIndividual",value:function(t){var e=t,n=t,a=!0;if(e instanceof Glue){var r=e.isLeft&&this._currentRightGlue&&e.parent==this._currentRightGlue.parent;r&&(this._currentRightGlue=null),(e.isLeft||e.isBi)&&this.TrimNewlinesFromOutputStream(r);var i=e.isRight&&null==this._currentRightGlue;i&&(this._currentRightGlue=e),a=e.isBi||i}else n instanceof StringValue&&(-1!=this.currentGlueIndex?n.isNewline?(this.TrimFromExistingGlue(),a=!1):n.isNonWhitespace&&(this.RemoveExistingGlue(),this._currentRightGlue=null):n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(a=!1)));a&&this._outputStream.push(t)}},{key:"TrimNewlinesFromOutputStream",value:function(t){for(var e=-1,n=-1,a=!1,r=this._outputStream.length-1;r>=0;){var i=this._outputStream[r],o=i,s=i,u=i;if(o instanceof ControlCommand||s instanceof StringValue&&s.isNonWhitespace){if(a=!0,!t)break}else{if(t&&u instanceof Glue&&u.isRight){n=r;break}s instanceof StringValue&&s.isNewline&&!a&&(e=r)}r--}if(e>=0)for(r=e;r<this._outputStream.length;){var l=this._outputStream[r];l instanceof StringValue?this._outputStream.splice(r,1):r++}t&&n>-1&&this._outputStream.splice(n,1)}},{key:"TrimFromExistingGlue",value:function(){for(var t=this.currentGlueIndex;t<this._outputStream.length;){var e=this._outputStream[t];e instanceof StringValue&&!e.isNonWhitespace?this._outputStream.splice(t,1):t++}}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof Glue)this._outputStream.splice(t,1);else if(e instanceof ControlCommand)break}}},{key:"ForceEndFlow",value:function(){for(this.currentContentObject=null;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)callStack.Pop();this.currentChoices.length=0,this.didSafeExit=!0}},{key:"SetChosenPath",value:function(t){this.currentChoices.length=0,this.currentPath=t,this._currentTurnIndex++}},{key:"AddError",value:function(t){null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t)}},{key:"VisitCountAtPathString",value:function(t){var e;return(e=this.visitCounts[t])?e:0}},{key:"Copy",value:function(){var e=new t(this.story);return e.outputStream.push.apply(e.outputStream,this._outputStream),e.currentChoices.push.apply(e.currentChoices,this.currentChoices),this.hasError&&(e.currentErrors=[],e.currentErrors.push.apply(e.currentErrors,this.currentErrors)),e._callStack=new CallStack(this.callStack),e._currentRightGlue=this._currentRightGlue,e._variablesState=new VariablesState(e.callStack),e.variablesState.CopyFrom(this.variablesState),e.evaluationStack.push.apply(e.evaluationStack,this.evaluationStack),null!=this.divertedTargetObject&&(e.divertedTargetObject=this.divertedTargetObject),e.previousContentObject=this.previousContentObject,e._visitCounts=this._visitCounts,e._turnIndices=this._turnIndices,e._currentTurnIndex=this.currentTurnIndex,e._storySeed=this.storySeed,e.didSafeExit=this.didSafeExit,e}},{key:"toJson",value:function(t){return JSON.stringify(this.jsonToken,null,t?2:0)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"currentChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"callStack",get:function(){return this._callStack}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"variablesState",get:function(){return this._variablesState}},{key:"storySeed",get:function(){return this._storySeed}},{key:"currentContentObject",get:function(){return this.callStack.currentElement.currentObject},set:function(t){this.callStack.currentElement.currentObject=t}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"outputStreamEndsInNewline",get:function(){if(this._outputStream.length>0)for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof ControlCommand)break;var n=this._outputStream[t];if(n instanceof StringValue){if(n.isNewline)return!0;if(n.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof StringValue)return!0;return!1}},{key:"currentGlueIndex",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t],n=e;if(n instanceof Glue)return t;if(e instanceof ControlCommand)break}return-1}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof ControlCommand&&e.commandType==ControlCommand.CommandType.BeginString)return!0}return!1}},{key:"currentText",get:function(){var t="";return this._outputStream.forEach(function(e){var n=e;n instanceof StringValue&&(t+=n.value)}),t}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentPath",get:function(){return null==this.currentContentObject?null:this.currentContentObject.path},set:function(t){null!=t?this.currentContentObject=this.story.ContentAtPath(t):this.currentContentObject=null}},{key:"currentContainer",get:function(){return this.callStack.currentElement.currentContainer}},{key:"previousContentObject",get:function(){return this.callStack.currentThread.previousContentObject},set:function(t){this.callStack.currentThread.previousContentObject=t}},{key:"jsonToken",get:function(){var e=this,n={},a=null;if(this.currentChoices.forEach(function(t){t.originalChoicePath=t.choicePoint.path.componentsString,t.originalThreadIndex=t.threadAtGeneration.threadIndex,null==e.callStack.ThreadWithIndex(t.originalThreadIndex)&&(null==a&&(a={}),a[t.originalThreadIndex.toString()]=t.threadAtGeneration.jsonToken)}),null!=this.choiceThreads&&(n.choiceThreads=this.choiceThreads),n.callstackThreads=this.callStack.GetJsonToken(),n.variablesState=this.variablesState.jsonToken,n.evalStack=JsonSerialisation.ListToJArray(this.evaluationStack),n.outputStream=JsonSerialisation.ListToJArray(this._outputStream),n.currentChoices=JsonSerialisation.ListToJArray(this.currentChoices),this._currentRightGlue){var r=this._outputStream.indexOf(this._currentRightGlue);-1!=r&&(n.currRightGlue=this._outputStream.indexOf(this._currentRightGlue))}return null!=this.divertedTargetObject&&(n.currentDivertTarget=this.divertedTargetObject.path.componentsString),n.visitCounts=JsonSerialisation.IntDictionaryToJObject(this.visitCounts),n.turnIndices=JsonSerialisation.IntDictionaryToJObject(this.turnIndices),n.turnIdx=this.currentTurnIndex,n.storySeed=this.storySeed,n.inkSaveVersion=t.kInkSaveStateVersion,n.inkFormatVersion=this.story.inkVersionCurrent,n},set:function(e){var n=this,a=e,r=a.inkSaveVersion;if(null==r)throw new StoryException("ink save format incorrect, can't load.");if(parseInt(r)<t.kMinCompatibleLoadVersion)throw new StoryException("Ink save format isn't compatible with the current version (saw '"+r+"', but minimum is "+t.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(a.callstackThreads,this.story),this.variablesState.jsonToken=a.variablesState,this._evaluationStack=JsonSerialisation.JArrayToRuntimeObjList(a.evalStack),this._outputStream=JsonSerialisation.JArrayToRuntimeObjList(a.outputStream),this._currentChoices=JsonSerialisation.JArrayToRuntimeObjList(a.currentChoices);var i;if(i=a.currRightGlue){var o=parseInt(i);o>=0&&(this._currentRightGlue=this._outputStream[o])}var s=a.currentDivertTarget;if(null!=s){var u=new Path$1(s.toString());this.divertedTargetObject=this.story.ContentAtPath(u)}this._visitCounts=JsonSerialisation.JObjectToIntDictionary(a.visitCounts),this._turnIndices=JsonSerialisation.JObjectToIntDictionary(a.turnIndices),this._currentTurnIndex=parseInt(a.turnIdx),this._storySeed=parseInt(a.storySeed);var l=a.choiceThreads;this.currentChoices.forEach(function(t){t.choicePoint=n.story.ContentAtPath(new Path$1(t.originalChoicePath));var e=n.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e;else{var a=l[t.originalThreadIndex.toString()];t.threadAtGeneration=new CallStack.Thread(a,n.story)}})}}]),t}();StoryState.kInkSaveStateVersion=4,StoryState.kMinCompatibleLoadVersion=4,Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&9007199254740992>t&&Math.floor(t)===t});var Story=function(t){function e(t){babelHelpers.classCallCheck(this,e);var n=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));if(n.inkVersionCurrent=12,n.inkVersionMinimumCompatible=12,n._variableObservers=null,n._externals={},t instanceof Container)n._mainContentContainer=t;else{var a="string"==typeof t?JSON.parse(t):t,r=a.inkVersion;if(null==r)throw"ink version number not found. Are you sure it's a valid .ink.json file?";var i=parseInt(r);if(i>n.inkVersionCurrent)throw"Version of ink used to build story was newer than the current verison of the engine";if(i<n.inkVersionMinimumCompatible)throw"Version of ink used to build story is too old to be loaded by this verison of the engine";i!=n.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var o=a.root;if(null==o)throw"Root node for ink not found. Are you sure it's a valid .ink.json file?";n._mainContentContainer=JsonSerialisation.JTokenToRuntimeObject(o),n._hasValidatedExternals=null,n.allowExternalFunctionFallbacks=!1,n.ResetState()}return n}return babelHelpers.inherits(e,t),babelHelpers.createClass(e,[{key:"ToJsonString",value:function(){var t=JsonSerialisation.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,JSON.stringify(e)}},{key:"ResetState",value:function(){this._state=new StoryState(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){this._state.ForceEndFlow()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent["global decl"]){var t=this.state.currentPath;this.ChoosePathString("global decl"),this.ContinueInternal(),this.state.currentPath=t}}},{key:"Continue",value:function(){return this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal()}},{key:"ContinueInternal",value:function(){if(!this.canContinue)throw new StoryException("Can't continue - should check canContinue before calling Continue");this._state.ResetOutput(),this._state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!0;try{var t=null;do if(this.Step(),this.canContinue||this.TryFollowDefaultInvisibleChoice(),!this.state.inStringEvaluation){if(null!=t){var e=this.currentText,n=t.currentText.length;if(e!==t.currentText){if(e.length>=n&&"\n"==e[n-1]){this.RestoreStateSnapshot(t);break}t=null}}this.state.outputStreamEndsInNewline&&(t=this.canContinue?this.StateSnapshot():null)}while(this.canContinue);null!=t&&this.RestoreStateSnapshot(t),this.canContinue||(this.state.callStack.canPopThread&&this.Error("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.currentChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(PushPopType.Tunnel)?this.Error("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(PushPopType.Function)?this.Error("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.Error("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.Error("ran out of content. Do you need a '-> DONE' or '-> END'?")))}catch(a){throw a}finally{this.state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!1}return this.currentText}},{key:"ContinueMaximally",value:function(){for(var t="";this.canContinue;)t+=this.Continue();return t}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentContentObject;if(null!=e){for(var n=e;n instanceof Container&&(this.VisitContainer(n,!0),0!=n.content.length);)e=n.content[0],this.state.callStack.currentElement.currentContentIndex=0,this.state.callStack.currentElement.currentContainer=n,n=e;n=this.state.callStack.currentElement.currentContainer;var a=this.PerformLogicAndFlowControl(e);if(null!=this.state.currentContentObject){a&&(t=!1);var r=e;if(r instanceof ChoicePoint){var i=this.ProcessChoice(r);i&&this.state.currentChoices.push(i),e=null,t=!1}if(e instanceof Container&&(t=!1),t){var o=e;if(o instanceof VariablePointerValue&&-1==o.contextIndex){var s=this.state.callStack.ContextForVariableNamed(o.variableName);e=new VariablePointerValue(o.variableName,s)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(e):this.state.PushToOutputStream(e)}this.NextContent();var u=e;u instanceof ControlCommand&&u.commandType==ControlCommand.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousContentObject,e=this.state.currentContentObject;if(e){var n=[];if(t)for(var a=t instanceof Container?t:t.parent;a instanceof Container;)n.push(a),a=a.parent;for(var r=e,i=r.parent;i instanceof Container&&n.indexOf(i)<0;){var o=i.content.length>0&&r==i.content[0];this.VisitContainer(i,o),r=i,i=i.parent}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var a="",r="";if(t.hasChoiceOnlyContent){var i=this.state.PopEvaluationStack();r=i.value}if(t.hasStartContent){var o=this.state.PopEvaluationStack();a=o.value}if(t.onceOnly){var s=this.VisitCountForContainer(t.choiceTarget);s>0&&(e=!1)}var u=new Choice(t);return u.threadAtGeneration=this.state.callStack.currentThread.Copy(),e?(u.text=a+r,u):null}},{key:"IsTruthy",value:function(t){var e=!1;if(t instanceof Value){var n=t;if(n instanceof DivertTargetValue){var a=n;return this.Error("Shouldn't use a divert target (to "+a.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return n.isTruthy}return e}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof Divert){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var a=e.variableDivertName,r=this.state.variablesState.GetVariableWithName(a);if(!(r instanceof DivertTargetValue)){var i=r,o="Tried to divert to a target from a variable, but the variable ("+a+") didn't contain a divert target, it ";o+=i instanceof IntValue&&0==i.value?"was empty/null (the value 0).":"contained '"+r+"'.",this.Error(o)}var s=r;this.state.divertedTargetObject=this.ContentAtPath(s.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedTargetObject=e.targetContent}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType),null!=this.state.divertedTargetObject||e.isExternal||(e&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof ControlCommand){var u=t;switch(u.commandType){case ControlCommand.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn("Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case ControlCommand.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn("Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case ControlCommand.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var l=this.state.PopEvaluationStack();
if(!(l instanceof Void)){var h=new StringValue(l.toString());this.state.PushToOutputStream(h)}}break;case ControlCommand.CommandType.NoOp:break;case ControlCommand.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case ControlCommand.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case ControlCommand.CommandType.PopFunction:case ControlCommand.CommandType.PopTunnel:var c=u.commandType==ControlCommand.CommandType.PopFunction?PushPopType.Function:PushPopType.Tunnel;if(this.state.callStack.currentElement.type==c&&this.state.callStack.canPop)this.state.callStack.Pop();else{var f=new{};f[PushPopType.Function]="function return statement (~ return)",f[PushPopType.Tunnel]="tunnel onwards statement (->->)";var p=f[this.state.callStack.currentElement.type];this.state.callStack.canPop||(p="end of flow (-> END or choice)");var v="Found "+f[c]+", when expected "+p;this.Error(v)}break;case ControlCommand.CommandType.BeginString:this.state.PushToOutputStream(u),this.state.inExpressionEvaluation||console.warn("Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case ControlCommand.CommandType.EndString:for(var d=[],C=0,y=this.state.outputStream.length-1;y>=0;--y){var m=this.state.outputStream[y];C++;var b=m;if(b instanceof ControlCommand&&b.commandType==ControlCommand.CommandType.BeginString)break;m instanceof StringValue&&d.push(m)}this.state.outputStream.splice(this.state.outputStream.length-C,C),d=d.reverse();var g="";d.forEach(function(t){g+=t.toString()}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new StringValue(g));break;case ControlCommand.CommandType.ChoiceCount:var k=this.currentChoices.length;this.state.PushEvaluationStack(new IntValue(k));break;case ControlCommand.CommandType.TurnsSince:var s=this.state.PopEvaluationStack();if(!(s instanceof DivertTargetValue)){var S="";s instanceof IntValue&&(S=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE expected a divert target (knot, stitch, label name), but saw "+s+S);break}var T=s,O=this.ContentAtPath(T.targetPath),_=this.TurnsSinceForContainer(O);this.state.PushEvaluationStack(new IntValue(_));break;case ControlCommand.CommandType.VisitIndex:var P=this.VisitCountForContainer(this.state.currentContainer)-1;this.state.PushEvaluationStack(new IntValue(P));break;case ControlCommand.CommandType.SequenceShuffleIndex:var E=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new IntValue(E));break;case ControlCommand.CommandType.StartThread:break;case ControlCommand.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():this.state.didSafeExit=!0;break;case ControlCommand.CommandType.End:this.state.ForceEndFlow();break;default:this.Error("unhandled ControlCommand: "+u)}return!0}if(t instanceof VariableAssignment){var V=t,x=this.state.PopEvaluationStack();return this.state.variablesState.Assign(V,x),!0}if(t instanceof VariableReference){var w=t,I=null;if(null!=w.pathForCount){var O=w.containerForCount,P=this.VisitCountForContainer(O);I=new IntValue(P)}else I=this.state.variablesState.GetVariableWithName(w.name),null==I&&(this.Error("Uninitialised variable: "+w.name),I=new IntValue(0));return this.state.evaluationStack.push(I),!0}if(t instanceof NativeFunctionCall){var N=t,F=this.state.PopEvaluationStack(N.numberOfParameters),A=N.Call(F);return this.state.evaluationStack.push(A),!0}return!1}},{key:"ChoosePathString",value:function(t){this.ChoosePath(new Path$1(t))}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;(0>t||t>e.length)&&console.warn("choice out of range");var n=e[t];this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.choicePoint.choiceTarget.path)}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.push(PushPopType.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.callStack.Pop();var a=this.state.evaluationStack.length;return a>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,e){var n=this._externals[t],a=null,r="undefined"!=typeof n;if(!r){if(this.allowExternalFunctionFallbacks)return a=this.ContentAtPath(new Path$1(t)),a instanceof Container||console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.push(PushPopType.Function),void(this.state.divertedTargetObject=a);console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var i=[],o=0;e>o;++o){var s=this.state.PopEvaluationStack(),u=s.valueObject;i.push(u)}i.reverse();var l=n(i),h=null;null!=l?(h=Value.Create(l),null==h&&console.warn("Could not create ink value from returned object of type "+l.GetType())):h=new Void,this.state.PushEvaluationStack(h)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunctionGeneral",value:function(t,e){this._externals[t]&&console.warn("Function '"+t+"' has already been bound."),this._externals[t]=e}},{key:"BindExternalFunction",value:function(t,e){var n=this;e||console.warn("Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){t.length<e.length&&console.warn("External function expected "+e.length+" arguments");for(var a=[],r=0,i=t.length;i>r;r++)a[r]=n.TryCoerce(t[r]);return e.apply(null,a)})}},{key:"UnbindExternalFunction",value:function(t){"undefined"==typeof this._externals[t]&&console.warn("Function '"+t+"' has not been bound."),delete this._externals[t]}},{key:"ValidateExternalBindings",value:function(t){var e=this;if(t)if(t instanceof Container){var n=t;n.content.forEach(function(t){e.ValidateExternalBindings(t)});for(var a in n.namedContent)this.ValidateExternalBindings(n.namedContent[a])}else{var r=t,i=r;if(i instanceof Divert&&i.isExternal){var o=i.targetPathString;if(!this._externals[o]){var s=this.mainContentContainer.namedContent[o],u="undefined"!=typeof s;this.allowExternalFunctionFallbacks?u||this.Error("Missing function binding for external '"+o+"', and no fallback ink function found."):this.Error("Missing function binding for external '"+o+"' (ink fallbacks disabled)")}}}else this.ValidateExternalBindings(this._mainContentContainer),this._hasValidatedExternals=!0}},{key:"ObserveVariable",value:function(t,e){null==this._variableObservers&&(this._variableObservers={}),this._variableObservers[t]?this._variableObservers[t].push(e):this._variableObservers[t]=[e]}},{key:"ObserveVariables",value:function(t,e){for(var n=0,a=t.length;a>n;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(null!=this._variableObservers)if("undefined"!=typeof e)this._variableObservers[e]&&this._variableObservers[e].splice(this._variableObservers[e].indexOf(t),1);else for(var n in this._variableObservers)this._variableObservers[n].splice(this._variableObservers[n].indexOf(t),1)}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!=this._variableObservers){var n=this._variableObservers[t];if("undefined"!=typeof e){if(!(e instanceof Value))throw"Tried to get the value of a variable that isn't a standard type";var a=e;n.forEach(function(e){e(t,a.valueObject)})}}}},{key:"BuildStringOfHierarchy",value:function(){var t="";return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentContentObject),t.toString()}},{key:"NextContent",value:function(){if(this.state.previousContentObject=this.state.currentContentObject,null==this.state.divertedTargetObject||(this.state.currentContentObject=this.state.divertedTargetObject,this.state.divertedTargetObject=null,this.VisitChangedContainersDueToDivert(),null==this.state.currentContentObject)){var t=this.IncrementContentPointer();if(!t){var e=!1;this.state.callStack.CanPop(PushPopType.Function)?(this.state.callStack.Pop(PushPopType.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new Void),e=!0):this.state.callStack.canPopThread&&(this.state.callStack.PopThread(),e=!0),e&&null!=this.state.currentContentObject&&this.NextContent()}}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement;for(e.currentContentIndex++;e.currentContentIndex>=e.currentContainer.content.length;){t=!1;var n=e.currentContainer.parent;if(n instanceof Container==!1)break;var a=n.content.indexOf(e.currentContainer);if(-1==a)break;e.currentContainer=n,e.currentContentIndex=a+1,t=!0}return t||(e.currentContainer=null),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.choicePoint.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;var n=e[0];return this.ChoosePath(n.choicePoint.choiceTarget.path),!0}},{key:"VisitCountForContainer",value:function(t){if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0,n=t.path.toString();return e=this.state.visitCounts[n]||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts[n]&&(e=this.state.visitCounts[n]),e++,this.state.visitCounts[n]=e}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e=t.path.toString();this.state.turnIndices[e]=this.state.currentTurnIndex}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices[e];return"undefined"!=typeof n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=this.state.PopEvaluationStack();if(!(t instanceof IntValue))return this.Error("expected number of elements in sequence for shuffle index"),0;for(var e=this.state.currentContainer,n=t.value,a=this.state.PopEvaluationStack(),r=a.value,i=r/n,o=r%n,s=e.path.toString(),u=0,l=0,h=s.length;h>l;l++)u+=parseInt(s[l])||0;for(var c=u+i+this.state.storySeed,f=new PRNG(parseInt(c)),p=[],l=0;n>l;++l)p.push(l);for(var l=0;o>=l;++l){var v=f.next()%p.length,d=p[v];if(p.splice(v,1),l==o)return d}throw"Should never reach here"}},{key:"Error",value:function(t,e){var n=new StoryException(t);throw n}},{key:"AddError",value:function(t,e){var n=null;if(null!=n){var a=e?n.endLineNumber:n.startLineNumber;t="RUNTIME ERROR: '"+n.fileName+"' line "+a+": "+t}else t="RUNTIME ERROR: "+t;this.state.AddError(t),this.state.ForceEndFlow()}},{key:"currentChoices",get:function(){var t=[];return this._state.currentChoices.forEach(function(e){e.choicePoint.isInvisibleDefault||(e.index=t.length,t.push(e))}),t}},{key:"currentText",get:function(){return this.state.currentText}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"hasError",get:function(){return this.state.hasError}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"state",get:function(){return this._state}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}},{key:"canContinue",get:function(){return null!=this.state.currentContentObject&&!this.state.hasError}}]),e}(InkObject);exports.Story=Story;